<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drixl Transporte â€“ Periodenvergleich</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a1018; color: #c8d2dc; font-family: 'DM Sans', sans-serif; padding: 24px 20px; min-height: 100vh; }
  .container { max-width: 1200px; margin: 0 auto; }
  .mono { font-family: 'JetBrains Mono', monospace; }

  /* â”€â”€ Header â”€â”€ */
  .header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; margin-bottom: 8px; }
  .header-sub { font-size: 11px; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: #2a6f4e; margin-bottom: 4px; }
  .header h1 { font-size: 28px; font-weight: 700; color: #e8edf2; line-height: 1.2; }
  .nav-link { font-size: 12px; color: #4ecdc4; text-decoration: none; border: 1px solid #1a3a4a; padding: 6px 14px; border-radius: 6px; transition: all 0.2s; }
  .nav-link:hover { background: #1a3a4a; color: #e8edf2; }

  /* â”€â”€ Period Selector â”€â”€ */
  .period-builder { background: #111820; border: 1px solid #1a2332; border-radius: 12px; padding: 20px 24px; margin: 20px 0 28px; }
  .pb-title { font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: #2a6f4e; margin-bottom: 16px; }
  .pb-row { display: flex; align-items: flex-end; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
  .pb-group { display: flex; flex-direction: column; gap: 4px; }
  .pb-label { font-size: 10px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: #5a6a7a; }
  
  select, input[type="date"] {
    background: #0a1018; border: 1px solid #1a2332; color: #c8d2dc; font-family: 'JetBrains Mono', monospace;
    font-size: 13px; padding: 8px 12px; border-radius: 6px; outline: none; transition: border 0.2s;
  }
  select:focus, input[type="date"]:focus { border-color: #2a6f4e; }
  select option { background: #111820; color: #c8d2dc; }

  .preset-btns { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 14px; }
  .preset-btn { padding: 5px 12px; border-radius: 5px; border: 1px solid #1a2332; cursor: pointer; font-size: 11px; font-weight: 600;
    font-family: 'JetBrains Mono', monospace; background: transparent; color: #5a6a7a; transition: all 0.2s; }
  .preset-btn:hover { border-color: #2a6f4e; color: #8a9aaa; }
  .preset-btn.active { background: #2a6f4e; border-color: #2a6f4e; color: #e8edf2; }

  /* Period chips */
  .period-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; min-height: 36px; align-items: center; }
  .chip { display: flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
    font-family: 'JetBrains Mono', monospace; border: 1px solid; }
  .chip .remove { cursor: pointer; opacity: 0.6; font-size: 14px; line-height: 1; }
  .chip .remove:hover { opacity: 1; }
  .chip-empty { font-size: 12px; color: #3a4a5a; padding: 8px 0; }

  .add-btn { padding: 7px 18px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 700;
    font-family: 'JetBrains Mono', monospace; background: #2a6f4e; color: #e8edf2; transition: all 0.2s; }
  .add-btn:hover { background: #35886a; }
  .add-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  .compare-btn { padding: 10px 28px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 700;
    font-family: 'JetBrains Mono', monospace; background: linear-gradient(135deg, #2a6f4e, #4ecdc4); color: #0a1018; transition: all 0.2s; letter-spacing: 0.04em; }
  .compare-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(78,205,196,0.3); }
  .compare-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; box-shadow: none; }

  /* â”€â”€ Results â”€â”€ */
  .section-title { font-size: 11px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: #2a6f4e; margin: 28px 0 14px; }

  .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
  .result-card { background: #111820; border: 1px solid #1a2332; border-radius: 12px; padding: 20px; }
  .result-card.full { grid-column: 1 / -1; }
  .chart-title { font-size: 13px; font-weight: 600; color: #5a6a7a; letter-spacing: 0.06em; text-transform: uppercase; margin-bottom: 16px; }
  .chart-wrap { position: relative; height: 300px; }

  /* Compare table */
  .compare-table { width: 100%; border-collapse: collapse; }
  .compare-table th { font-size: 11px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: #5a6a7a; 
    padding: 10px 12px; text-align: left; border-bottom: 1px solid #1a2332; }
  .compare-table td { font-size: 13px; padding: 10px 12px; border-bottom: 1px solid #0f1620; }
  .compare-table tr:hover td { background: #0f1620; }
  .compare-table .num { text-align: right; font-weight: 600; }
  .compare-table .green { color: #4ecdc4; }
  .compare-table .red { color: #ff6b6b; }
  .compare-table .label { color: #8a9aaa; }

  .footer { text-align: center; padding: 32px 0 16px; color: #2a3a4a; font-size: 11px; }

  .loading { display: flex; align-items: center; justify-content: center; min-height: 40vh; }
  .spinner { width: 20px; height: 20px; border: 2px solid #4ecdc4; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px; }

  .empty-hint { text-align: center; padding: 60px 20px; color: #3a4a5a; }
  .empty-hint .icon { font-size: 40px; margin-bottom: 12px; }
  .empty-hint .text { font-size: 14px; line-height: 1.6; }

  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .fade-in { animation: fadeIn 0.5s ease; }

  @media (max-width: 768px) {
    .result-grid { grid-template-columns: 1fr; }
    .pb-row { flex-direction: column; align-items: stretch; }
    .header h1 { font-size: 22px; }
  }
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <div>
      <div class="header-sub mono">Drixl Transporte GmbH</div>
      <h1>Periodenvergleich</h1>
    </div>
    <div style="display: flex; gap: 8px; align-items: center;">
      <a href="/" class="nav-link mono">â† Dashboard</a>
      <a href="/api/logout" class="mono" style="font-size: 11px; color: #5a6a7a; text-decoration: none; padding: 6px 10px; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.color='#ff6b6b'" onmouseout="this.style.color='#5a6a7a'">â» Logout</a>
    </div>
  </div>

  <!-- â•â•â• PERIOD BUILDER â•â•â• -->
  <div class="period-builder" id="builder">
    <div class="pb-title mono">Perioden auswÃ¤hlen</div>

    <!-- Presets -->
    <div class="preset-btns" id="presetBtns">
      <button class="preset-btn mono active" onclick="setMode('quarter')">Quartale</button>
      <button class="preset-btn mono" onclick="setMode('month')">Monate</button>
      <button class="preset-btn mono" onclick="setMode('year')">Jahre</button>
      <button class="preset-btn mono" onclick="setMode('custom')">Eigener Zeitraum</button>
    </div>

    <!-- Quarter selector -->
    <div class="pb-row" id="quarterRow">
      <div class="pb-group">
        <span class="pb-label mono">Quartal</span>
        <select id="selQuarter">
          <option value="1">Q1 (Jan â€“ MÃ¤r)</option>
          <option value="2">Q2 (Apr â€“ Jun)</option>
          <option value="3">Q3 (Jul â€“ Sep)</option>
          <option value="4">Q4 (Okt â€“ Dez)</option>
        </select>
      </div>
      <div class="pb-group">
        <span class="pb-label mono">Jahr</span>
        <select id="selQuarterYear"></select>
      </div>
      <button class="add-btn mono" onclick="addPeriod()">+ HinzufÃ¼gen</button>
    </div>

    <!-- Month selector -->
    <div class="pb-row" id="monthRow" style="display:none;">
      <div class="pb-group">
        <span class="pb-label mono">Monat</span>
        <select id="selMonth">
          <option value="1">Januar</option><option value="2">Februar</option><option value="3">MÃ¤rz</option>
          <option value="4">April</option><option value="5">Mai</option><option value="6">Juni</option>
          <option value="7">Juli</option><option value="8">August</option><option value="9">September</option>
          <option value="10">Oktober</option><option value="11">November</option><option value="12">Dezember</option>
        </select>
      </div>
      <div class="pb-group">
        <span class="pb-label mono">Jahr</span>
        <select id="selMonthYear"></select>
      </div>
      <button class="add-btn mono" onclick="addPeriod()">+ HinzufÃ¼gen</button>
    </div>

    <!-- Year selector -->
    <div class="pb-row" id="yearRow" style="display:none;">
      <div class="pb-group">
        <span class="pb-label mono">Jahr</span>
        <select id="selYear"></select>
      </div>
      <button class="add-btn mono" onclick="addPeriod()">+ HinzufÃ¼gen</button>
    </div>

    <!-- Custom selector -->
    <div class="pb-row" id="customRow" style="display:none;">
      <div class="pb-group">
        <span class="pb-label mono">Von</span>
        <input type="date" id="customFrom">
      </div>
      <div class="pb-group">
        <span class="pb-label mono">Bis</span>
        <input type="date" id="customTo">
      </div>
      <button class="add-btn mono" onclick="addPeriod()">+ HinzufÃ¼gen</button>
    </div>

    <!-- Selected periods -->
    <div class="period-chips" id="chips">
      <span class="chip-empty mono">Noch keine Perioden ausgewÃ¤hlt â€“ fÃ¼ge mindestens 2 hinzu</span>
    </div>

    <div style="margin-top: 16px; display: flex; gap: 12px; align-items: center;">
      <button class="compare-btn mono" id="compareBtn" onclick="runComparison()" disabled>Vergleichen</button>
      <span id="compareHint" class="mono" style="font-size: 11px; color: #3a4a5a;">Mindestens 2 Perioden wÃ¤hlen</span>
    </div>
  </div>

  <!-- â•â•â• RESULTS â•â•â• -->
  <div id="results">
    <div class="empty-hint">
      <div class="icon">ğŸ“Š</div>
      <div class="text">WÃ¤hle oben Perioden aus und klicke auf <strong>Vergleichen</strong>,<br>um einen detaillierten Periodenvergleich zu erstellen.</div>
    </div>
  </div>

  <div class="footer mono">
    Daten via bexio API Â· Powered by Supabase
  </div>
</div>

<script>
const SUPABASE_URL = "https://nzfwdehuacrwisuixdxu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56ZndkZWh1YWNyd2lzdWl4ZHh1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MTI2ODUzNywiZXhwIjoyMDg2ODQ0NTM3fQ._jj5KHUulpgC1VInd0_7m-AsMA-MkhcJsDkN-1x5xXU";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let mode = "quarter";
let periods = [];  // { id, label, from, to, color }
let allData = null;
let chartInstances = {};

const COLORS = ['#4ecdc4','#e8a54b','#ff6b6b','#6cb4ee','#a78bfa','#f472b6','#34d399','#fbbf24'];
const MONTH_NAMES = ["Jan","Feb","MÃ¤r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function query(table, params = "") {
  const allRows = [];
  let offset = 0;
  while (true) {
    const url = `${SUPABASE_URL}/rest/v1/${table}?${params}&offset=${offset}&limit=1000`;
    try {
      const res = await fetch(url, { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}`, Prefer: "count=exact" } });
      if (!res.ok) { console.warn(`${table}@${offset}: HTTP ${res.status}`); break; }
      const batch = await res.json();
      if (!Array.isArray(batch) || batch.length === 0) break;
      allRows.push(...batch);
      console.log(`  ${table}: ${allRows.length} (batch ${batch.length})`);
      if (batch.length < 1000) break;
      offset += 1000;
    } catch (e) { console.error(`${table}@${offset}: error`, e); break; }
  }
  console.log(`âœ“ ${table}: ${allRows.length} total`);
  return allRows;
}

async function loadData() {
  if (allData) return allData;
  console.log("Loading invoices...");
  const invoices = await query("invoices", "select=id,is_valid_from,total_gross,total_net,status,contact_id,document_nr");
  console.log("Loading quotes...");
  const quotes = await query("quotes", "select=id,is_valid_from,total_net,status,created_at");
  console.log("Loading contacts...");
  const contacts = await query("contacts", "select=id,name_1,name_2");
  console.log("Loading payments...");
  const payments = await query("incoming_payments", "select=id,invoice_id,payment_date,amount");
  const cm = {};
  contacts.forEach(c => cm[c.id] = [c.name_1, c.name_2].filter(Boolean).join(" "));
  const payMap = {};
  payments.forEach(p => { if (!payMap[p.invoice_id]) payMap[p.invoice_id] = []; payMap[p.invoice_id].push(p); });
  allData = { invoices, quotes, cm, payMap };
  console.log(`=== ALL LOADED === inv:${invoices.length} quotes:${quotes.length} contacts:${contacts.length} pay:${payments.length}`);
  return allData;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERIOD BUILDER UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function populateYearSelects() {
  const now = new Date().getFullYear();
  const years = [];
  for (let y = now; y >= 2015; y--) years.push(y);
  const html = years.map(y => `<option value="${y}">${y}</option>`).join("");
  document.getElementById("selQuarterYear").innerHTML = html;
  document.getElementById("selMonthYear").innerHTML = html;
  document.getElementById("selYear").innerHTML = html;
}

function setMode(m) {
  mode = m;
  document.querySelectorAll(".preset-btn").forEach(b => b.classList.remove("active"));
  document.querySelector(`.preset-btn[onclick="setMode('${m}')"]`).classList.add("active");
  document.getElementById("quarterRow").style.display = m === "quarter" ? "flex" : "none";
  document.getElementById("monthRow").style.display = m === "month" ? "flex" : "none";
  document.getElementById("yearRow").style.display = m === "year" ? "flex" : "none";
  document.getElementById("customRow").style.display = m === "custom" ? "flex" : "none";
}

function addPeriod() {
  let label, from, to;

  if (mode === "quarter") {
    const q = parseInt(document.getElementById("selQuarter").value);
    const y = parseInt(document.getElementById("selQuarterYear").value);
    label = `Q${q}/${y}`;
    const sm = (q - 1) * 3;
    from = new Date(y, sm, 1);
    to = new Date(y, sm + 3, 0);
  } else if (mode === "month") {
    const m = parseInt(document.getElementById("selMonth").value);
    const y = parseInt(document.getElementById("selMonthYear").value);
    label = `${MONTH_NAMES[m-1]} ${y}`;
    from = new Date(y, m - 1, 1);
    to = new Date(y, m, 0);
  } else if (mode === "year") {
    const y = parseInt(document.getElementById("selYear").value);
    label = `${y}`;
    from = new Date(y, 0, 1);
    to = new Date(y, 11, 31);
  } else {
    const fv = document.getElementById("customFrom").value;
    const tv = document.getElementById("customTo").value;
    if (!fv || !tv) return;
    from = new Date(fv);
    to = new Date(tv);
    if (from >= to) return;
    label = `${from.toLocaleDateString('de-CH')} â€“ ${to.toLocaleDateString('de-CH')}`;
  }

  // Check duplicate
  if (periods.find(p => p.label === label)) return;
  if (periods.length >= 8) return;

  const color = COLORS[periods.length % COLORS.length];
  periods.push({ id: Date.now(), label, from, to, color });
  renderChips();
}

function removePeriod(id) {
  periods = periods.filter(p => p.id !== id);
  // Reassign colors
  periods.forEach((p, i) => p.color = COLORS[i % COLORS.length]);
  renderChips();
}

function renderChips() {
  const el = document.getElementById("chips");
  if (periods.length === 0) {
    el.innerHTML = `<span class="chip-empty mono">Noch keine Perioden ausgewÃ¤hlt â€“ fÃ¼ge mindestens 2 hinzu</span>`;
  } else {
    el.innerHTML = periods.map(p => `
      <div class="chip mono" style="background: ${p.color}15; border-color: ${p.color}40; color: ${p.color};">
        ${p.label}
        <span class="remove" onclick="removePeriod(${p.id})">âœ•</span>
      </div>
    `).join("");
  }
  const btn = document.getElementById("compareBtn");
  const hint = document.getElementById("compareHint");
  btn.disabled = periods.length < 2;
  hint.textContent = periods.length < 2 ? `Noch ${2 - periods.length} Periode(n) hinzufÃ¼gen` : `${periods.length} Perioden bereit`;
  hint.style.color = periods.length >= 2 ? '#4ecdc4' : '#3a4a5a';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPARISON LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function formatCHF(v) {
  const n = parseFloat(v) || 0;
  if (Math.abs(n) >= 1000000) return `CHF ${(n/1000000).toFixed(2)} Mio`;
  if (Math.abs(n) >= 10000) return `CHF ${(n/1000).toFixed(0)}K`;
  if (Math.abs(n) >= 1000) return `CHF ${(n/1000).toFixed(1)}K`;
  return `CHF ${n.toFixed(0)}`;
}
function formatNum(v) { return new Intl.NumberFormat("de-CH").format(v || 0); }

function inPeriod(dateStr, from, to) {
  if (!dateStr) return false;
  const d = new Date(dateStr);
  return d >= from && d <= to;
}

function computePeriodStats(data, period) {
  const { invoices, quotes, cm, payMap } = data;
  const { from, to } = period;

  const invs = invoices.filter(i => i.status !== "cancelled" && i.status !== "draft" && inPeriod(i.is_valid_from, from, to));
  const revenue = invs.reduce((s, i) => s + parseFloat(i.total_net || 0), 0);
  const count = invs.length;
  const avg = count > 0 ? revenue / count : 0;

  // Unique customers
  const custs = new Set(invs.map(i => i.contact_id).filter(Boolean));

  // Quotes
  const qs = quotes.filter(q => inPeriod(q.is_valid_from || q.created_at, from, to));
  const qTotal = qs.length;
  const qAccepted = qs.filter(q => q.status === "accepted").length;
  const qConv = qTotal > 0 ? (qAccepted / qTotal * 100) : 0;

  // DSO
  const paidInvs = invoices.filter(i => i.status === "paid" && inPeriod(i.is_valid_from, from, to));
  let dsoSum = 0, dsoCount = 0;
  paidInvs.forEach(inv => {
    if (!payMap[inv.id]) return;
    const pays = payMap[inv.id].filter(p => p.payment_date);
    if (pays.length === 0) return;
    const lastPay = pays.sort((a, b) => new Date(b.payment_date) - new Date(a.payment_date))[0];
    const days = Math.round((new Date(lastPay.payment_date) - new Date(inv.is_valid_from)) / 86400000);
    if (days >= 0 && days < 365) { dsoSum += days; dsoCount++; }
  });
  const dso = dsoCount > 0 ? dsoSum / dsoCount : 0;

  // Top 5 customers in this period
  const custRev = {};
  invs.forEach(inv => {
    if (!inv.contact_id) return;
    if (!custRev[inv.contact_id]) custRev[inv.contact_id] = { id: inv.contact_id, total: 0 };
    custRev[inv.contact_id].total += parseFloat(inv.total_net || 0);
  });
  const topCust = Object.values(custRev).sort((a, b) => b.total - a.total).slice(0, 5);

  // Monthly breakdown within period
  const monthlyRev = {};
  invs.forEach(inv => {
    const d = new Date(inv.is_valid_from);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    monthlyRev[key] = (monthlyRev[key] || 0) + parseFloat(inv.total_net || 0);
  });

  return { revenue, count, avg, customers: custs.size, qTotal, qAccepted, qConv, dso, dsoCount, topCust, monthlyRev };
}

async function runComparison() {
  if (periods.length < 2) return;

  const results = document.getElementById("results");
  results.innerHTML = `<div class="loading"><div class="spinner"></div><span style="color: #4ecdc4;">Lade & berechne...</span></div>`;

  const data = await loadData();
  const stats = periods.map(p => ({ ...p, stats: computePeriodStats(data, p) }));

  // Destroy old charts
  Object.values(chartInstances).forEach(c => c.destroy());
  chartInstances = {};

  renderResults(stats, data.cm);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESULTS RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderResults(stats, cm) {
  const el = document.getElementById("results");

  // Best period for each metric
  const bestRev = Math.max(...stats.map(s => s.stats.revenue));
  const bestAvg = Math.max(...stats.map(s => s.stats.avg));
  const bestDso = Math.min(...stats.filter(s => s.stats.dso > 0).map(s => s.stats.dso)) || 0;
  const bestConv = Math.max(...stats.map(s => s.stats.qConv));

  // Comparison table rows
  const metrics = [
    { label: "Umsatz (Netto)", key: "revenue", fmt: formatCHF, best: "max" },
    { label: "Anzahl Rechnungen", key: "count", fmt: formatNum, best: "max" },
    { label: "Ã˜ Rechnungsbetrag", key: "avg", fmt: formatCHF, best: "max" },
    { label: "Aktive Kunden", key: "customers", fmt: formatNum, best: "max" },
    { label: "Offerten Total", key: "qTotal", fmt: formatNum, best: "max" },
    { label: "Offerten angenommen", key: "qAccepted", fmt: formatNum, best: "max" },
    { label: "Offert-Quote", key: "qConv", fmt: v => v.toFixed(1) + "%", best: "max" },
    { label: "Ã˜ Zahlungsfrist", key: "dso", fmt: v => v > 0 ? v.toFixed(0) + " Tage" : "â€“", best: "min" },
  ];

  const tableHeader = `<th class="mono label">Kennzahl</th>` + stats.map(s =>
    `<th class="mono num" style="color: ${s.color};">${s.label}</th>`
  ).join("") + `<th class="mono num">Î”</th>`;

  const tableRows = metrics.map(m => {
    const vals = stats.map(s => s.stats[m.key]);
    const best = m.best === "max" ? Math.max(...vals) : Math.min(...vals.filter(v => v > 0));
    const first = vals[0], last = vals[vals.length - 1];
    let delta = "";
    if (m.key === "dso") {
      if (first > 0 && last > 0) {
        const diff = last - first;
        delta = `<span class="${diff < 0 ? 'green' : diff > 0 ? 'red' : ''}">${diff > 0 ? '+' : ''}${diff.toFixed(0)} T</span>`;
      }
    } else if (m.key === "qConv") {
      const diff = last - first;
      delta = `<span class="${diff > 0 ? 'green' : diff < 0 ? 'red' : ''}">${diff > 0 ? '+' : ''}${diff.toFixed(1)}%</span>`;
    } else if (first > 0) {
      const pctDiff = ((last - first) / first * 100);
      delta = `<span class="${pctDiff > 0 ? 'green' : pctDiff < 0 ? 'red' : ''}">${pctDiff > 0 ? '+' : ''}${pctDiff.toFixed(1)}%</span>`;
    }

    return `<tr>
      <td class="label mono">${m.label}</td>
      ${vals.map((v, i) => {
        const isBest = m.best === "max" ? v === best && v > 0 : v === best && v > 0;
        return `<td class="num mono" style="${isBest ? 'color: #4ecdc4; font-weight: 700;' : ''}">${m.fmt(v)}</td>`;
      }).join("")}
      <td class="num mono">${delta}</td>
    </tr>`;
  }).join("");

  el.innerHTML = `
    <div class="fade-in">
      <!-- Comparison Table -->
      <div class="section-title mono">ğŸ“Š Kennzahlen-Vergleich</div>
      <div class="result-card" style="background: #111820; border: 1px solid #1a2332; border-radius: 12px; padding: 20px; margin-bottom: 24px; overflow-x: auto;">
        <table class="compare-table">
          <thead><tr>${tableHeader}</tr></thead>
          <tbody>${tableRows}</tbody>
        </table>
      </div>

      <!-- Charts -->
      <div class="section-title mono">ğŸ“ˆ Visualisierungen</div>
      <div class="result-grid">
        <div class="result-card">
          <div class="chart-title mono">Umsatz-Vergleich</div>
          <div class="chart-wrap"><canvas id="cmpRevenueChart"></canvas></div>
        </div>
        <div class="result-card">
          <div class="chart-title mono">Ã˜ Rechnungsbetrag</div>
          <div class="chart-wrap"><canvas id="cmpAvgChart"></canvas></div>
        </div>
        <div class="result-card">
          <div class="chart-title mono">Rechnungen & Kunden</div>
          <div class="chart-wrap"><canvas id="cmpCountChart"></canvas></div>
        </div>
        <div class="result-card">
          <div class="chart-title mono">Offerten & Zahlungsmoral</div>
          <div class="chart-wrap"><canvas id="cmpMixChart"></canvas></div>
        </div>
      </div>

      <!-- Top Kunden per Period -->
      <div class="section-title mono">ğŸ‘¥ Top Kunden pro Periode</div>
      <div class="result-grid">
        ${stats.map(s => `
          <div class="result-card">
            <div class="chart-title mono" style="color: ${s.color};">${s.label}</div>
            ${s.stats.topCust.length === 0 ? '<div style="color: #3a4a5a; font-size: 13px;">Keine Daten</div>' :
              s.stats.topCust.map((c, i) => `
                <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #0f1620;">
                  <span class="mono" style="font-size: 12px; color: #8a9aaa;"><span style="color: #3a4a5a; margin-right: 6px;">${i+1}.</span>${(cm[c.id] || '#'+c.id).substring(0, 25)}</span>
                  <span class="mono" style="font-size: 12px; font-weight: 600; color: ${s.color};">${formatCHF(c.total)}</span>
                </div>
              `).join("")
            }
          </div>
        `).join("")}
      </div>
    </div>
  `;

  // Draw comparison charts
  drawCmpRevenueChart(stats);
  drawCmpAvgChart(stats);
  drawCmpCountChart(stats);
  drawCmpMixChart(stats);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPARISON CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const cDefs = {
  responsive: true, maintainAspectRatio: false,
  plugins: { tooltip: {
    backgroundColor: '#1a2332', borderColor: '#2a3a4a', borderWidth: 1,
    titleFont: { family: "'JetBrains Mono'" }, bodyFont: { family: "'JetBrains Mono'" },
  }},
};
const axDef = {
  x: { grid: { display: false }, ticks: { color: '#4a5a6a', font: { family: "'JetBrains Mono'", size: 11 } } },
  y: { grid: { color: '#1a2332' }, ticks: { color: '#3a4a5a', font: { family: "'JetBrains Mono'", size: 10 } } }
};

function drawCmpRevenueChart(stats) {
  const ctx = document.getElementById('cmpRevenueChart'); if (!ctx) return;
  chartInstances.rev = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: stats.map(s => s.label),
      datasets: [{ data: stats.map(s => s.stats.revenue), backgroundColor: stats.map(s => s.color),
        borderRadius: 6, borderSkipped: false, maxBarThickness: 80 }]
    },
    options: { ...cDefs, plugins: { ...cDefs.plugins, legend: { display: false },
      tooltip: { ...cDefs.plugins.tooltip, callbacks: { label: c => formatCHF(c.raw) } } },
      scales: { ...axDef, y: { ...axDef.y, ticks: { ...axDef.y.ticks, callback: v => formatCHF(v) } } } }
  });
}

function drawCmpAvgChart(stats) {
  const ctx = document.getElementById('cmpAvgChart'); if (!ctx) return;
  chartInstances.avg = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: stats.map(s => s.label),
      datasets: [{ data: stats.map(s => s.stats.avg), backgroundColor: stats.map(s => s.color + '90'),
        borderColor: stats.map(s => s.color), borderWidth: 2, borderRadius: 6, borderSkipped: false, maxBarThickness: 80 }]
    },
    options: { ...cDefs, plugins: { ...cDefs.plugins, legend: { display: false },
      tooltip: { ...cDefs.plugins.tooltip, callbacks: { label: c => `Ã˜ ${formatCHF(c.raw)}` } } },
      scales: { ...axDef, y: { ...axDef.y, ticks: { ...axDef.y.ticks, callback: v => formatCHF(v) } } } }
  });
}

function drawCmpCountChart(stats) {
  const ctx = document.getElementById('cmpCountChart'); if (!ctx) return;
  chartInstances.cnt = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: stats.map(s => s.label),
      datasets: [
        { label: 'Rechnungen', data: stats.map(s => s.stats.count), backgroundColor: stats.map(s => s.color), borderRadius: 4, borderSkipped: false },
        { label: 'Kunden', data: stats.map(s => s.stats.customers), backgroundColor: stats.map(s => s.color + '50'),
          borderColor: stats.map(s => s.color), borderWidth: 1, borderRadius: 4, borderSkipped: false },
      ]
    },
    options: { ...cDefs, plugins: {
      legend: { display: true, position: 'top', labels: { color: '#5a6a7a', font: { family: "'JetBrains Mono'", size: 10 }, boxWidth: 12, padding: 12 } },
      tooltip: { ...cDefs.plugins.tooltip } },
      scales: axDef }
  });
}

function drawCmpMixChart(stats) {
  const ctx = document.getElementById('cmpMixChart'); if (!ctx) return;
  chartInstances.mix = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: stats.map(s => s.label),
      datasets: [
        { label: 'Offert-Quote %', data: stats.map(s => s.stats.qConv), backgroundColor: '#4a90d9', borderRadius: 4, borderSkipped: false, yAxisID: 'y' },
        { label: 'Ã˜ Zahlungsfrist (Tage)', data: stats.map(s => s.stats.dso), backgroundColor: '#e8a54b', borderRadius: 4, borderSkipped: false, yAxisID: 'y1' },
      ]
    },
    options: { ...cDefs, plugins: {
      legend: { display: true, position: 'top', labels: { color: '#5a6a7a', font: { family: "'JetBrains Mono'", size: 10 }, boxWidth: 12, padding: 12 } },
      tooltip: { ...cDefs.plugins.tooltip } },
      scales: {
        ...axDef,
        y: { ...axDef.y, position: 'left', title: { display: true, text: 'Quote %', color: '#4a90d9', font: { family: "'JetBrains Mono'", size: 10 } } },
        y1: { ...axDef.y, position: 'right', grid: { display: false }, title: { display: true, text: 'Tage', color: '#e8a54b', font: { family: "'JetBrains Mono'", size: 10 } } },
      } }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

populateYearSelects();

// Auto-add a useful default: last 3 Q1s
const curYear = new Date().getFullYear();
const curQ = Math.floor(new Date().getMonth() / 3) + 1;
</script>
</body>
</html>
