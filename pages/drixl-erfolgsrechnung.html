<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drixl Transporte â€“ Erfolgsrechnung</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a1018; color: #c8d2dc; font-family: 'DM Sans', sans-serif; padding: 24px 20px; min-height: 100vh; }
  .container { max-width: 1400px; margin: 0 auto; }
  .mono { font-family: 'JetBrains Mono', monospace; }

  /* â”€â”€ Header â”€â”€ */
  .header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; margin-bottom: 8px; }
  .header-sub { font-size: 11px; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: #2a6f4e; margin-bottom: 4px; }
  .header h1 { font-size: 28px; font-weight: 700; color: #e8edf2; line-height: 1.2; }
  .nav-links { display: flex; gap: 8px; flex-wrap: wrap; }
  .nav-link { font-size: 12px; color: #4ecdc4; text-decoration: none; border: 1px solid #1a3a4a; padding: 6px 14px; border-radius: 6px; transition: all 0.2s; }
  .nav-link:hover { background: #1a3a4a; color: #e8edf2; }

  /* â”€â”€ Period Selector â”€â”€ */
  .period-builder { background: #111820; border: 1px solid #1a2332; border-radius: 12px; padding: 20px 24px; margin: 20px 0 28px; }
  .pb-title { font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: #2a6f4e; margin-bottom: 16px; }
  .pb-row { display: flex; align-items: flex-end; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
  .pb-group { display: flex; flex-direction: column; gap: 4px; }
  .pb-label { font-size: 10px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: #5a6a7a; }
  
  select, input[type="date"] {
    background: #0a1018; border: 1px solid #1a2332; color: #c8d2dc; font-family: 'JetBrains Mono', monospace;
    font-size: 13px; padding: 8px 12px; border-radius: 6px; outline: none; transition: border 0.2s;
  }
  select:focus, input[type="date"]:focus { border-color: #2a6f4e; }
  select option { background: #111820; color: #c8d2dc; }

  .preset-btns { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 14px; }
  .preset-btn { padding: 5px 12px; border-radius: 5px; border: 1px solid #1a2332; cursor: pointer; font-size: 11px; font-weight: 600;
    font-family: 'JetBrains Mono', monospace; background: transparent; color: #5a6a7a; transition: all 0.2s; }
  .preset-btn:hover { border-color: #2a6f4e; color: #8a9aaa; }
  .preset-btn.active { background: #2a6f4e; border-color: #2a6f4e; color: #e8edf2; }

  .period-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; min-height: 36px; align-items: center; }
  .chip { display: flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
    font-family: 'JetBrains Mono', monospace; border: 1px solid; }
  .chip .remove { cursor: pointer; opacity: 0.6; font-size: 14px; line-height: 1; }
  .chip .remove:hover { opacity: 1; }
  .chip-empty { font-size: 12px; color: #3a4a5a; padding: 8px 0; }

  .add-btn { padding: 7px 18px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 700;
    font-family: 'JetBrains Mono', monospace; background: #2a6f4e; color: #e8edf2; transition: all 0.2s; }
  .add-btn:hover { background: #35886a; }

  .compare-btn { padding: 10px 28px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 700;
    font-family: 'JetBrains Mono', monospace; background: linear-gradient(135deg, #2a6f4e, #4ecdc4); color: #0a1018; transition: all 0.2s; letter-spacing: 0.04em; }
  .compare-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(78,205,196,0.3); }
  .compare-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; box-shadow: none; }

  /* â”€â”€ P&L Table â”€â”€ */
  .pl-wrap { background: #111820; border: 1px solid #1a2332; border-radius: 12px; padding: 20px; overflow-x: auto; }
  .pl-table { width: 100%; border-collapse: collapse; min-width: 600px; }
  .pl-table th { font-size: 11px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: #5a6a7a;
    padding: 10px 8px; text-align: right; border-bottom: 2px solid #1a2332; white-space: nowrap; position: sticky; top: 0; background: #111820; z-index: 2; }
  .pl-table th:first-child { text-align: left; min-width: 300px; }
  .pl-table td { font-size: 12px; padding: 5px 8px; border-bottom: 1px solid #0f1620; }
  .pl-table td:first-child { color: #8a9aaa; }
  .pl-table td:not(:first-child) { text-align: right; font-weight: 500; }
  .pl-table tr:hover td { background: #0f1620; }

  /* Row types */
  .pl-table .row-account td:first-child { padding-left: 24px; font-size: 12px; color: #7a8a9a; }
  .pl-table .row-account .acct-no { color: #3a4a5a; margin-right: 6px; font-size: 11px; }
  .pl-table .row-group td { font-weight: 700; color: #c8d2dc !important; border-top: 1px solid #1a2332; background: #0d151e; }
  .pl-table .row-group td:first-child { padding-left: 12px; font-size: 12px; }
  .pl-table .row-section td { font-weight: 700; color: #e8edf2 !important; border-top: 2px solid #2a6f4e; border-bottom: 2px solid #1a2332; background: #0a1218; font-size: 13px; }
  .pl-table .row-section td:first-child { padding-left: 0; }
  .pl-table .row-result td { font-weight: 700; color: #4ecdc4 !important; border-top: 2px solid #4ecdc4; background: #0d1a1e; font-size: 13px; }
  .pl-table .row-result td:first-child { padding-left: 0; }

  .pos { color: #4ecdc4; }
  .neg { color: #ff6b6b; }
  .zero { color: #2a3a4a; }
  .delta-col { font-size: 10px !important; }

  .loading { display: flex; align-items: center; justify-content: center; min-height: 40vh; }
  .spinner { width: 20px; height: 20px; border: 2px solid #4ecdc4; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px; }
  .empty-hint { text-align: center; padding: 60px 20px; color: #3a4a5a; }
  .empty-hint .icon { font-size: 40px; margin-bottom: 12px; }
  .empty-hint .text { font-size: 14px; line-height: 1.6; }
  .footer { text-align: center; padding: 32px 0 16px; color: #2a3a4a; font-size: 11px; }

  /* Toggle for zero rows */
  .toggle-row { display: flex; align-items: center; gap: 8px; margin-top: 12px; }
  .toggle-row label { font-size: 11px; color: #5a6a7a; cursor: pointer; user-select: none; }
  .toggle-row input { accent-color: #2a6f4e; }

  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .fade-in { animation: fadeIn 0.5s ease; }

  @media (max-width: 768px) {
    .pb-row { flex-direction: column; align-items: stretch; }
    .header h1 { font-size: 22px; }
  }
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <div>
      <div class="header-sub mono">Drixl Transporte GmbH</div>
      <h1>Erfolgsrechnung</h1>
    </div>
    <div class="nav-links">
      <a href="/" class="nav-link mono">â† Dashboard</a>
      <a href="/vergleich" class="nav-link mono">ğŸ“Š Vergleich</a>
    </div>
  </div>

  <!-- â•â•â• PERIOD BUILDER â•â•â• -->
  <div class="period-builder" id="builder">
    <div class="pb-title mono">Perioden auswÃ¤hlen (bis zu 4)</div>

    <div class="preset-btns" id="presetBtns">
      <button class="preset-btn mono active" onclick="setMode('month')">Monat</button>
      <button class="preset-btn mono" onclick="setMode('quarter')">Quartal</button>
      <button class="preset-btn mono" onclick="setMode('halfyear')">Halbjahr</button>
      <button class="preset-btn mono" onclick="setMode('year')">Jahr</button>
      <button class="preset-btn mono" onclick="setMode('custom')">Eigener Zeitraum</button>
    </div>

    <!-- Month selector -->
    <div class="pb-row" id="monthRow">
      <div class="pb-group">
        <span class="pb-label mono">Monat</span>
        <select id="selMonth">
          <option value="1">Januar</option><option value="2">Februar</option><option value="3">MÃ¤rz</option>
          <option value="4">April</option><option value="5">Mai</option><option value="6">Juni</option>
          <option value="7">Juli</option><option value="8">August</option><option value="9">September</option>
          <option value="10">Oktober</option><option value="11">November</option><option value="12">Dezember</option>
        </select>
      </div>
      <div class="pb-group">
        <span class="pb-label mono">Jahr</span>
        <select id="selMonthYear"></select>
      </div>
      <button class="add-btn mono" onclick="addPeriod()">+ HinzufÃ¼gen</button>
    </div>

    <!-- Quarter selector -->
    <div class="pb-row" id="quarterRow" style="display:none;">
      <div class="pb-group">
        <span class="pb-label mono">Quartal</span>
        <select id="selQuarter">
          <option value="1">Q1 (Jan â€“ MÃ¤r)</option>
          <option value="2">Q2 (Apr â€“ Jun)</option>
          <option value="3">Q3 (Jul â€“ Sep)</option>
          <option value="4">Q4 (Okt â€“ Dez)</option>
        </select>
      </div>
      <div class="pb-group">
        <span class="pb-label mono">Jahr</span>
        <select id="selQuarterYear"></select>
      </div>
      <button class="add-btn mono" onclick="addPeriod()">+ HinzufÃ¼gen</button>
    </div>

    <!-- Half-year selector -->
    <div class="pb-row" id="halfyearRow" style="display:none;">
      <div class="pb-group">
        <span class="pb-label mono">Halbjahr</span>
        <select id="selHalfyear">
          <option value="1">H1 (Jan â€“ Jun)</option>
          <option value="2">H2 (Jul â€“ Dez)</option>
        </select>
      </div>
      <div class="pb-group">
        <span class="pb-label mono">Jahr</span>
        <select id="selHalfyearYear"></select>
      </div>
      <button class="add-btn mono" onclick="addPeriod()">+ HinzufÃ¼gen</button>
    </div>

    <!-- Year selector -->
    <div class="pb-row" id="yearRow" style="display:none;">
      <div class="pb-group">
        <span class="pb-label mono">Jahr</span>
        <select id="selYear"></select>
      </div>
      <button class="add-btn mono" onclick="addPeriod()">+ HinzufÃ¼gen</button>
    </div>

    <!-- Custom selector -->
    <div class="pb-row" id="customRow" style="display:none;">
      <div class="pb-group">
        <span class="pb-label mono">Von</span>
        <input type="date" id="customFrom">
      </div>
      <div class="pb-group">
        <span class="pb-label mono">Bis</span>
        <input type="date" id="customTo">
      </div>
      <button class="add-btn mono" onclick="addPeriod()">+ HinzufÃ¼gen</button>
    </div>

    <!-- Selected periods -->
    <div class="period-chips" id="chips">
      <span class="chip-empty mono">WÃ¤hle mindestens 1 Periode â€“ bis zu 4 fÃ¼r Vergleich</span>
    </div>

    <div style="margin-top: 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
      <button class="compare-btn mono" id="compareBtn" onclick="runPL()" disabled>Anzeigen</button>
      <span id="compareHint" class="mono" style="font-size: 11px; color: #3a4a5a;">Mindestens 1 Periode wÃ¤hlen</span>
      <div class="toggle-row">
        <input type="checkbox" id="hideZero" checked>
        <label for="hideZero" class="mono">Null-Konten ausblenden</label>
      </div>
    </div>
  </div>

  <!-- â•â•â• RESULTS â•â•â• -->
  <div id="results">
    <div class="empty-hint">
      <div class="icon">ğŸ“‹</div>
      <div class="text">WÃ¤hle oben eine oder mehrere Perioden aus und klicke auf <strong>Anzeigen</strong>,<br>
      um die Erfolgsrechnung zu erstellen.</div>
    </div>
  </div>

  <div class="footer mono">
    Daten via bexio Journal API Â· Powered by Supabase
  </div>
</div>

<script>
const SUPABASE_URL = "https://nzfwdehuacrwisuixdxu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56ZndkZWh1YWNyd2lzdWl4ZHh1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MTI2ODUzNywiZXhwIjoyMDg2ODQ0NTM3fQ._jj5KHUulpgC1VInd0_7m-AsMA-MkhcJsDkN-1x5xXU";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let mode = "month";
let periods = [];
let cachedAccounts = null;
let journalCache = {};

const COLORS = ['#4ecdc4','#e8a54b','#ff6b6b','#6cb4ee'];
const MONTH_NAMES = ["Jan","Feb","MÃ¤r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// P&L STRUCTURE - matches bexio Erfolgsrechnung exactly
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PL_STRUCTURE = [
  // Each entry: { type: 'account'|'group'|'section'|'result', label, accounts?, compute? }
  { type: 'group', label: 'Ãœbrige EtrÃ¤ge', accounts: [3000, 3020, 3700] },
  { type: 'group', label: 'Ertrag UmzÃ¼ge', accounts: [3030, 3120, 3121, 3140] },
  { type: 'group', label: 'Ertrag Spez Transport', accounts: [3210, 3211, 3212, 3213, 3220, 3221] },
  { type: 'group', label: 'Logistik', accounts: [3310, 3320, 3330, 3340, 3350, 3400] },
  { type: 'group', label: 'IndustrieumzÃ¼ge', accounts: [3410, 3411, 3412, 3413] },
  { type: 'group', label: 'ErlÃ¶sminderung / Verluste', accounts: [3010, 3800, 3809, 3905] },
  { type: 'section', label: 'Betrieblicher Ertrag aus Lieferungen und Leistungen', sumGroups: [0,1,2,3,4,5] },

  { type: 'group', label: 'Aufwand fÃ¼r Material, Handelswaren, DL und Energie', accounts: [4000, 4300] },
  { type: 'group', label: 'Aufwand fÃ¼r bezogene Dienstleistungen', accounts: [4400, 4441, 4442, 4451, 4452, 4453, 4454] },
  { type: 'group', label: 'Aufwandminderung', accounts: [4900, 4910] },
  { type: 'section', label: 'Diverser Betriebsaufwand', sumGroups: [7,8,9] },

  { type: 'result', label: 'Bruttoergebnis 1 (Bruttogewinn)', sumSections: [6, 10] },

  { type: 'group', label: 'Lohnaufwand', accounts: [5000, 5001, 5002, 5003, 5005, 5008] },
  { type: 'group', label: 'Sozialversicherungen', accounts: [5700, 5710, 5711, 5720, 5730, 5740, 5790] },
  { type: 'group', label: 'diverser Personalaufwand', accounts: [5800, 5810, 5820, 5821, 5832, 5890, 5891] },
  { type: 'group', label: 'Leistungen dritter', accounts: [5900] },
  { type: 'section', label: 'Personalaufwand', sumGroups: [12,13,14,15] },

  { type: 'result', label: 'Bruttoergebnis 2', sumSections: [6, 10, 16] },

  { type: 'group', label: 'RÃ¤umlichkeiten', accounts: [6000, 6001, 6040, 6041] },
  { type: 'group', label: 'Unterhalt, Reparatur, Ersatz', accounts: [6100, 6110, 6131, 6150] },
  { type: 'group', label: 'Fahrzeuge', accounts: [6200, 6201, 6202, 6203, 6204, 6205, 6206, 6207, 6208, 6210, 6211, 6212, 6213, 6214, 6220, 6230, 6260, 6270] },
  { type: 'group', label: 'Sachver. Abg., GebÃ¼hren, Bewill.', accounts: [6300, 6360] },
  { type: 'group', label: 'Energie- i. Entsorgungskosten', accounts: [6400, 6460] },
  { type: 'group', label: 'Verwaltungsaufwand', accounts: [6500, 6510, 6513, 6520, 6530] },
  { type: 'group', label: 'Werbeaufwand', accounts: [6600, 6642, 6643] },
  { type: 'group', label: 'Ãœbriger Betriebsaufwand', accounts: [6790] },

  { type: 'result', label: 'EBITDA', customCalc: 'ebitda' },

  { type: 'group', label: 'Ãœbriger Betriebsaufwand (Rundung)', accounts: [6945] },
  { type: 'group', label: 'Finanzerfolg', accounts: [6800, 6801, 6850] },
  { type: 'group', label: 'Vorteil/Nachteil Saldosteuersatz', accounts: [6899] },

  { type: 'result', label: 'EBIT', customCalc: 'ebit' },

  { type: 'group', label: 'Abschreibungen', accounts: [6920, 6921, 6923, 6924] },
  { type: 'group', label: 'Finanzertrag/Aufwand', accounts: [6900, 6950] },

  { type: 'section', label: 'Sonstiger Betriebsaufwand', customCalc: 'sonstiger' },

  { type: 'group', label: 'Betriebsfremder Aufwand/Ertrag', accounts: [8000, 8100] },
  { type: 'group', label: 'ausserordentlich', accounts: [8500, 8510] },

  { type: 'result', label: 'Unternehmensergebnis vor Steuern', customCalc: 'vorSteuern' },

  { type: 'group', label: 'ausserordentlich (8910)', accounts: [8910] },
  { type: 'group', label: 'Steuern', accounts: [8900] },

  { type: 'result', label: 'Nicht verbuchter Erfolg', customCalc: 'nettoresult' },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function query(table, params = "") {
  const allRows = [];
  let offset = 0;
  while (true) {
    const url = `${SUPABASE_URL}/rest/v1/${table}?${params}&offset=${offset}&limit=10000`;
    const res = await fetch(url, { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } });
    const batch = await res.json();
    if (!Array.isArray(batch) || batch.length === 0) break;
    allRows.push(...batch);
    if (batch.length < 10000) break;
    offset += 10000;
  }
  return allRows;
}

async function loadAccounts() {
  if (cachedAccounts) return cachedAccounts;
  const accts = await query("accounts", "select=id,account_no,name,account_type&account_no=gte.3000&account_no=lte.9999&order=account_no");
  cachedAccounts = {};
  accts.forEach(a => {
    cachedAccounts[a.account_no] = a;
  });
  // Also build idâ†’account_no map for journal lookup
  cachedAccounts._byId = {};
  accts.forEach(a => { cachedAccounts._byId[a.id] = a; });
  return cachedAccounts;
}

async function loadJournalForPeriod(fromDate, toDate) {
  // Load only journal entries for the specific date range
  const cacheKey = fromDate + '_' + toDate;
  if (journalCache[cacheKey]) return journalCache[cacheKey];
  // Direct fetch â€” a year has max ~8k entries, fits in one call
  const url = `${SUPABASE_URL}/rest/v1/journal_entries?select=id,amount,date,debit_account_id,credit_account_id&date=gte.${fromDate}&date=lte.${toDate}&limit=10000`;
  const res = await fetch(url, { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } });
  const data = await res.json();
  journalCache[cacheKey] = Array.isArray(data) ? data : [];
  return journalCache[cacheKey];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// P&L CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function calcAccountBalance(journal, accounts, accountNo, fromDate, toDate) {
  // Find account by account_no
  const acct = accounts[accountNo];
  if (!acct) return 0;
  const acctId = acct.id;
  const acctType = acct.account_type; // 1=Revenue, 2=Expense

  let creditSum = 0, debitSum = 0;
  for (const j of journal) {
    // Date filter
    if (j.date < fromDate || j.date > toDate) continue;
    if (j.credit_account_id === acctId) creditSum += j.amount;
    if (j.debit_account_id === acctId) debitSum += j.amount;
  }

  // Revenue (type 1): positive = credit - debit (ErtrÃ¤ge appear as positive)
  // Expense (type 2): negative = -(debit - credit) â†’ credit - debit (AufwÃ¤nde appear as negative)
  // Actually: In bexio P&L, revenue shows as positive, expense as negative
  // Revenue: credit - debit = positive number
  // Expense: credit - debit = negative number (because expenses are booked on debit side)
  return creditSum - debitSum;
}

function calcPeriodPL(journal, accounts, fromStr, toStr) {
  const results = {};
  const groupTotals = {};

  // Calculate each row
  PL_STRUCTURE.forEach((row, idx) => {
    if (row.type === 'account' || row.type === 'group') {
      if (row.accounts) {
        let total = 0;
        const acctBalances = {};
        row.accounts.forEach(acctNo => {
          const bal = calcAccountBalance(journal, accounts, acctNo, fromStr, toStr);
          acctBalances[acctNo] = bal;
          total += bal;
        });
        groupTotals[idx] = total;
        results[idx] = { total, acctBalances };
      }
    } else if (row.type === 'section') {
      if (row.sumGroups) {
        let total = 0;
        row.sumGroups.forEach(gi => { total += (groupTotals[gi] || 0); });
        groupTotals[idx] = total;
        results[idx] = { total };
      } else if (row.customCalc === 'sonstiger') {
        // Sum all groups from RÃ¤umlichkeiten(18) through Ãœbriger BA(25) + Rundung(27) + Finanzerfolg(28) + Saldo(29) + Abschr(31) + Finanz(32)
        [18,19,20,21,22,23,24,25,27,28,29,31,32].forEach(gi => { total += (groupTotals[gi] || 0); });
        groupTotals[idx] = total;
        results[idx] = { total };
      }
    } else if (row.type === 'result') {
      let total = 0;
      if (row.sumSections) {
        row.sumSections.forEach(si => { total += (groupTotals[si] || 0); });
      } else if (row.customCalc === 'ebitda') {
        // Bruttoergebnis 2 (idx 17) + RÃ¤umlichkeiten through Ãœbriger BA
        total = (groupTotals[17] || 0);
        [18,19,20,21,22,23,24,25].forEach(gi => { total += (groupTotals[gi] || 0); });
      } else if (row.customCalc === 'ebit') {
        // EBITDA + Rundung + Finanzerfolg + Saldosteuersatz
        total = (groupTotals[26] || 0); // EBITDA
        [27,28,29].forEach(gi => { total += (groupTotals[gi] || 0); });
      } else if (row.customCalc === 'vorSteuern') {
        // EBIT(30) + Abschreibungen(31) + Finanzertrag/Aufwand(32) + Betriebsfremd(34) + ausserordentlich(35)
        total = (groupTotals[30] || 0); // EBIT
        [31,32,34,35].forEach(gi => { total += (groupTotals[gi] || 0); });
      } else if (row.customCalc === 'nettoresult') {
        // Vor Steuern(36) + ausserordentlich 8910(37) + Steuern(38)
        total = (groupTotals[36] || 0); // vor Steuern
        [37,38].forEach(gi => { total += (groupTotals[gi] || 0); });
      }
      groupTotals[idx] = total;
      results[idx] = { total };
    }
  });

  return { results, groupTotals };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERIOD BUILDER UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function populateYearSelects() {
  const now = new Date().getFullYear();
  const years = [];
  for (let y = now; y >= 2015; y--) years.push(y);
  const html = years.map(y => `<option value="${y}">${y}</option>`).join("");
  ["selMonthYear","selQuarterYear","selHalfyearYear","selYear"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = html;
  });
}

function setMode(m) {
  mode = m;
  document.querySelectorAll(".preset-btn").forEach(b => b.classList.remove("active"));
  document.querySelector(`.preset-btn[onclick="setMode('${m}')"]`).classList.add("active");
  ["monthRow","quarterRow","halfyearRow","yearRow","customRow"].forEach(id => {
    document.getElementById(id).style.display = "none";
  });
  document.getElementById(m + "Row").style.display = "flex";
}

function addPeriod() {
  let label, from, to;

  if (mode === "month") {
    const m = parseInt(document.getElementById("selMonth").value);
    const y = parseInt(document.getElementById("selMonthYear").value);
    label = `${MONTH_NAMES[m-1]} ${y}`;
    from = `${y}-${String(m).padStart(2,'0')}-01`;
    const lastDay = new Date(y, m, 0).getDate();
    to = `${y}-${String(m).padStart(2,'0')}-${lastDay}`;
  } else if (mode === "quarter") {
    const q = parseInt(document.getElementById("selQuarter").value);
    const y = parseInt(document.getElementById("selQuarterYear").value);
    label = `Q${q}/${y}`;
    const sm = (q - 1) * 3 + 1;
    from = `${y}-${String(sm).padStart(2,'0')}-01`;
    const em = sm + 2;
    const lastDay = new Date(y, em, 0).getDate();
    to = `${y}-${String(em).padStart(2,'0')}-${lastDay}`;
  } else if (mode === "halfyear") {
    const h = parseInt(document.getElementById("selHalfyear").value);
    const y = parseInt(document.getElementById("selHalfyearYear").value);
    label = `H${h}/${y}`;
    if (h === 1) { from = `${y}-01-01`; to = `${y}-06-30`; }
    else { from = `${y}-07-01`; to = `${y}-12-31`; }
  } else if (mode === "year") {
    const y = parseInt(document.getElementById("selYear").value);
    label = `${y}`;
    from = `${y}-01-01`;
    to = `${y}-12-31`;
  } else {
    const fv = document.getElementById("customFrom").value;
    const tv = document.getElementById("customTo").value;
    if (!fv || !tv || fv >= tv) return;
    from = fv; to = tv;
    label = `${new Date(fv).toLocaleDateString('de-CH')} â€“ ${new Date(tv).toLocaleDateString('de-CH')}`;
  }

  if (periods.find(p => p.label === label)) return;
  if (periods.length >= 4) return;

  const color = COLORS[periods.length % COLORS.length];
  periods.push({ id: Date.now(), label, from, to, color });
  renderChips();
}

function removePeriod(id) {
  periods = periods.filter(p => p.id !== id);
  periods.forEach((p, i) => p.color = COLORS[i % COLORS.length]);
  renderChips();
}

function renderChips() {
  const el = document.getElementById("chips");
  if (periods.length === 0) {
    el.innerHTML = `<span class="chip-empty mono">WÃ¤hle mindestens 1 Periode â€“ bis zu 4 fÃ¼r Vergleich</span>`;
  } else {
    el.innerHTML = periods.map(p => `
      <div class="chip mono" style="background: ${p.color}15; border-color: ${p.color}40; color: ${p.color};">
        ${p.label}
        <span class="remove" onclick="removePeriod(${p.id})">âœ•</span>
      </div>
    `).join("");
  }
  const btn = document.getElementById("compareBtn");
  const hint = document.getElementById("compareHint");
  btn.disabled = periods.length < 1;
  hint.textContent = periods.length < 1 ? 'Mindestens 1 Periode wÃ¤hlen' : `${periods.length} Periode(n) bereit`;
  hint.style.color = periods.length >= 1 ? '#4ecdc4' : '#3a4a5a';
  btn.textContent = periods.length > 1 ? 'Vergleichen' : 'Anzeigen';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function fmtCHF(v) {
  if (v === 0) return '0.00';
  const sign = v < 0 ? '-' : '';
  const abs = Math.abs(v);
  // Swiss format: 1'234.56
  const parts = abs.toFixed(2).split('.');
  const intPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, "'");
  return `${sign}${intPart}.${parts[1]}`;
}

function fmtDelta(v1, v2) {
  if (v1 === 0 && v2 === 0) return '';
  if (v1 === 0) return v2 !== 0 ? '<span class="pos">neu</span>' : '';
  const pct = ((v2 - v1) / Math.abs(v1) * 100);
  if (Math.abs(pct) < 0.01) return '';
  const cls = pct > 0 ? 'pos' : 'neg';
  return `<span class="${cls}">${pct > 0 ? '+' : ''}${pct.toFixed(1)}%</span>`;
}

function valClass(v) {
  if (v === 0) return 'zero';
  return v > 0 ? 'pos' : 'neg';
}

async function runPL() {
  if (periods.length < 1) return;
  const results = document.getElementById("results");
  results.innerHTML = `<div class="loading"><div class="spinner"></div><span class="mono" style="color: #4ecdc4;">Lade Daten...</span></div>`;

  // Load accounts + all period journals in parallel
  const [accounts, ...journals] = await Promise.all([
    loadAccounts(),
    ...periods.map(p => loadJournalForPeriod(p.from, p.to))
  ]);

  const hideZero = document.getElementById("hideZero").checked;

  const periodResults = periods.map((p, i) => ({
    ...p,
    pl: calcPeriodPL(journals[i], accounts, p.from, p.to)
  }));

  renderPLTable(periodResults, accounts, hideZero);
}

function renderPLTable(periodResults, accounts, hideZero) {
  const el = document.getElementById("results");
  const numPeriods = periodResults.length;
  const showDelta = numPeriods >= 2;

  // Build header
  let headerHTML = `<th class="mono">Konto</th>`;
  periodResults.forEach(p => {
    headerHTML += `<th class="mono" style="color: ${p.color};">${p.label}</th>`;
  });
  if (showDelta) headerHTML += `<th class="mono delta-col">+/-%</th>`;

  // Build rows
  let rowsHTML = '';
  PL_STRUCTURE.forEach((row, idx) => {
    if (row.type === 'group' && row.accounts) {
      // First: individual account rows
      row.accounts.forEach(acctNo => {
        const acct = accounts[acctNo];
        if (!acct) return;
        const vals = periodResults.map(p => p.pl.results[idx]?.acctBalances?.[acctNo] || 0);
        const allZero = vals.every(v => v === 0);
        if (hideZero && allZero) return;

        let cells = `<td><span class="acct-no mono">${acctNo}</span>${acct.name}</td>`;
        vals.forEach(v => {
          cells += `<td class="mono ${valClass(v)}">${fmtCHF(v)}</td>`;
        });
        if (showDelta) {
          cells += `<td class="mono delta-col">${fmtDelta(vals[0], vals[numPeriods-1])}</td>`;
        }
        rowsHTML += `<tr class="row-account">${cells}</tr>`;
      });

      // Group subtotal
      const groupVals = periodResults.map(p => p.pl.results[idx]?.total || 0);
      const groupAllZero = groupVals.every(v => v === 0);
      if (hideZero && groupAllZero) return;

      let groupCells = `<td>${row.label}</td>`;
      groupVals.forEach(v => {
        groupCells += `<td class="mono ${valClass(v)}">${fmtCHF(v)}</td>`;
      });
      if (showDelta) {
        groupCells += `<td class="mono delta-col">${fmtDelta(groupVals[0], groupVals[numPeriods-1])}</td>`;
      }
      rowsHTML += `<tr class="row-group">${groupCells}</tr>`;

    } else if (row.type === 'section') {
      const sectionVals = periodResults.map(p => p.pl.results[idx]?.total || 0);
      let sectionCells = `<td>${row.label}</td>`;
      sectionVals.forEach(v => {
        sectionCells += `<td class="mono ${valClass(v)}">${fmtCHF(v)}</td>`;
      });
      if (showDelta) {
        sectionCells += `<td class="mono delta-col">${fmtDelta(sectionVals[0], sectionVals[numPeriods-1])}</td>`;
      }
      rowsHTML += `<tr class="row-section">${sectionCells}</tr>`;

    } else if (row.type === 'result') {
      const resultVals = periodResults.map(p => p.pl.results[idx]?.total || 0);
      let resultCells = `<td>â¯ˆ ${row.label}</td>`;
      resultVals.forEach(v => {
        resultCells += `<td class="mono ${valClass(v)}">${fmtCHF(v)}</td>`;
      });
      if (showDelta) {
        resultCells += `<td class="mono delta-col">${fmtDelta(resultVals[0], resultVals[numPeriods-1])}</td>`;
      }
      rowsHTML += `<tr class="row-result">${resultCells}</tr>`;
    }
  });

  el.innerHTML = `
    <div class="fade-in">
      <div class="pl-wrap">
        <table class="pl-table">
          <thead><tr>${headerHTML}</tr></thead>
          <tbody>${rowsHTML}</tbody>
        </table>
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

populateYearSelects();

// Auto-select current month
const now = new Date();
document.getElementById("selMonth").value = now.getMonth() + 1;
</script>
</body>
</html>
