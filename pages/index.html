<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drixl Transporte ‚Äì Finance Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a1018; color: #c8d2dc; font-family: 'DM Sans', sans-serif; padding: 24px 20px; min-height: 100vh; }
  .container { max-width: 1200px; margin: 0 auto; }
  .mono { font-family: 'JetBrains Mono', monospace; }
  
  .header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; margin-bottom: 32px; animation: fadeIn 0.5s ease; }
  .header-sub { font-size: 11px; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: #2a6f4e; margin-bottom: 4px; }
  .header h1 { font-size: 28px; font-weight: 700; color: #e8edf2; line-height: 1.2; }
  
  .year-btns { display: flex; gap: 6px; flex-wrap: wrap; }
  .year-btn { padding: 6px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'JetBrains Mono', monospace; background: #111820; color: #5a6a7a; transition: all 0.2s; }
  .year-btn.active { background: #2a6f4e; color: #e8edf2; }
  .year-btn:hover { background: #1a2832; color: #8a9aaa; }
  .year-btn.active:hover { background: #35886a; }

  .section-title { font-size: 11px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: #2a6f4e; margin: 28px 0 14px; padding-left: 2px; }

  .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 24px; animation: fadeIn 0.6s ease; }
  .kpi-card { background: #111820; border: 1px solid #1a2332; border-radius: 12px; padding: 18px 20px; position: relative; overflow: hidden; }
  .kpi-card.accent { background: linear-gradient(135deg, #1a2332 0%, #0f1923 100%); border-color: #2a6f4e; }
  .kpi-card.accent::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #2a6f4e, #4ecdc4); }
  .kpi-card.warn { border-color: #5a4520; }
  .kpi-card.warn::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #e8a54b, #ff6b6b); }
  .kpi-card.info { border-color: #1a3355; }
  .kpi-card.info::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #4a90d9, #6cb4ee); }
  .kpi-label { font-size: 11px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: #5a6a7a; margin-bottom: 6px; }
  .kpi-value { font-size: 26px; font-weight: 700; color: #e8edf2; line-height: 1.1; margin-bottom: 4px; }
  .kpi-card.accent .kpi-value { color: #4ecdc4; }
  .kpi-card.warn .kpi-value { color: #e8a54b; }
  .kpi-card.info .kpi-value { color: #6cb4ee; }
  .kpi-sub { font-size: 12px; color: #4a5a6a; }
  .kpi-sub.green { color: #4ecdc4; }
  .kpi-sub.red { color: #ff6b6b; }

  .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; animation: fadeIn 0.7s ease; }
  .chart-card { background: #111820; border: 1px solid #1a2332; border-radius: 12px; padding: 20px; }
  .chart-title { font-size: 13px; font-weight: 600; color: #5a6a7a; letter-spacing: 0.06em; text-transform: uppercase; margin-bottom: 16px; }
  .chart-wrap { position: relative; height: 240px; }

  .bottom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; animation: fadeIn 0.8s ease; }
  .list-card { background: #111820; border: 1px solid #1a2332; border-radius: 12px; padding: 20px; }

  .customer-row { padding: 8px 0; }
  .customer-row:hover { background: #0f1620; border-radius: 6px; }
  .customer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .customer-name { font-size: 13px; color: #c8d2dc; font-weight: 500; }
  .customer-rank { color: #3a4a5a; font-size: 11px; margin-right: 8px; }
  .customer-amount { font-size: 13px; font-weight: 600; color: #4ecdc4; white-space: nowrap; }
  .mini-bar { width: 100%; height: 4px; background: #1a2332; border-radius: 2px; overflow: hidden; }
  .mini-bar-fill { height: 100%; background: #2a6f4e; border-radius: 2px; transition: width 1s ease; }

  .inv-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 4px; border-radius: 4px; }
  .inv-row:hover { background: #0f1620; }
  .inv-name { font-size: 13px; color: #c8d2dc; font-weight: 500; }
  .inv-detail { font-size: 11px; color: #3a4a5a; }
  .inv-amount { font-size: 14px; font-weight: 600; color: #e8a54b; white-space: nowrap; }

  .funnel-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
  .funnel-label { font-size: 12px; color: #8a9aaa; width: 90px; text-align: right; flex-shrink: 0; }
  .funnel-bar-wrap { flex: 1; height: 28px; background: #0f1620; border-radius: 6px; overflow: hidden; }
  .funnel-bar { height: 100%; border-radius: 6px; display: flex; align-items: center; padding: 0 10px; font-size: 12px; font-weight: 600; color: #e8edf2; transition: width 1s ease; }
  .funnel-count { font-size: 11px; color: #5a6a7a; width: 60px; text-align: right; flex-shrink: 0; }

  .footer { text-align: center; padding: 32px 0 16px; color: #2a3a4a; font-size: 11px; }
  .empty-state { text-align: center; padding: 40px; color: #3a4a5a; }
  .empty-state .icon { font-size: 32px; margin-bottom: 8px; }
  .loading { display: flex; align-items: center; justify-content: center; min-height: 80vh; }
  .spinner { width: 20px; height: 20px; border: 2px solid #4ecdc4; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px; }
  
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  @media (max-width: 900px) {
    .charts-grid, .bottom-grid { grid-template-columns: 1fr; }
    .kpi-grid { grid-template-columns: 1fr 1fr; }
    .header h1 { font-size: 22px; }
  }
</style>
</head>
<body>
<div class="container" id="app">
  <div class="loading">
    <div class="spinner"></div>
    <span style="color: #4ecdc4; font-size: 18px;">Lade Daten von Supabase...</span>
  </div>
</div>

<script>
const SUPABASE_URL = "https://nzfwdehuacrwisuixdxu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56ZndkZWh1YWNyd2lzdWl4ZHh1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MTI2ODUzNywiZXhwIjoyMDg2ODQ0NTM3fQ._jj5KHUulpgC1VInd0_7m-AsMA-MkhcJsDkN-1x5xXU";

let activeYear = new Date().getFullYear();
let charts = {};

async function query(table, params = "") {
  const allData = [];
  let offset = 0;
  const batchSize = 1000;
  while (true) {
    const url = `${SUPABASE_URL}/rest/v1/${table}?${params}&offset=${offset}&limit=${batchSize}`;
    try {
      const res = await fetch(url, {
        headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}`, Prefer: "count=exact" }
      });
      if (!res.ok) { console.warn(`${table} batch@${offset}: HTTP ${res.status}`); break; }
      const batch = await res.json();
      if (!Array.isArray(batch)) { console.warn(`${table} batch@${offset}: not array`, batch); break; }
      if (batch.length === 0) break;
      allData.push(...batch);
      console.log(`  ${table}: loaded ${allData.length} (batch ${batch.length})`);
      if (batch.length < batchSize) break;
      offset += batchSize;
    } catch (e) {
      console.error(`${table} batch@${offset}: fetch error`, e);
      break;
    }
  }
  console.log(`‚úì ${table}: ${allData.length} total records`);
  return allData;
}

function formatCHF(v) {
  const n = parseFloat(v) || 0;
  if (n >= 1000000) return `CHF ${(n/1000000).toFixed(2)} Mio`;
  if (n >= 10000) return `CHF ${(n/1000).toFixed(0)}K`;
  if (n >= 1000) return `CHF ${(n/1000).toFixed(1)}K`;
  return `CHF ${n.toFixed(0)}`;
}
function formatNum(v) { return new Intl.NumberFormat("de-CH").format(v || 0); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA LOADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

window._allData = {};

async function loadAllData() {
  // Sequential loading to avoid Supabase rate limits
  console.log("Loading invoices...");
  const invoices = await query("invoices", "select=id,is_valid_from,total_gross,total_net,total_taxes,status,contact_id,document_nr,created_at,updated_at");
  console.log("Loading quotes...");
  const quotes = await query("quotes", "select=id,is_valid_from,total_gross,total_net,status,created_at");
  console.log("Loading orders...");
  const orders = await query("orders", "select=id,total_gross,total_net,status,is_valid_from");
  console.log("Loading contacts...");
  const contacts = await query("contacts", "select=id,name_1,name_2");
  console.log("Loading payments...");
  const payments = await query("incoming_payments", "select=id,invoice_id,payment_date,amount");
  window._allData = { invoices, quotes, orders, contacts, payments };
  console.log(`=== ALL DATA LOADED === invoices:${invoices.length} quotes:${quotes.length} orders:${orders.length} contacts:${contacts.length} payments:${payments.length}`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA PROCESSING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function processData() {
  const { invoices, quotes, orders, contacts, payments } = window._allData;

  const cm = {};
  contacts.forEach(c => cm[c.id] = [c.name_1, c.name_2].filter(Boolean).join(" "));

  const revenueInv = invoices.filter(i => i.status !== "cancelled" && i.status !== "draft");
  const paidInv = invoices.filter(i => i.status === "paid");

  // ‚îÄ‚îÄ Yearly ‚îÄ‚îÄ
  const yearly = {};
  revenueInv.forEach(inv => {
    if (!inv.is_valid_from) return;
    const y = new Date(inv.is_valid_from).getFullYear();
    if (!yearly[y]) yearly[y] = { year: y, revenue: 0, count: 0 };
    yearly[y].revenue += parseFloat(inv.total_net || 0);
    yearly[y].count++;
  });
  const yearlyData = Object.values(yearly).sort((a, b) => a.year - b.year);
  const years = yearlyData.map(y => y.year);

  // ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ
  const totalRevenue = revenueInv.reduce((s, i) => s + parseFloat(i.total_net || 0), 0);
  const curYearRev = yearly[activeYear]?.revenue || 0;

  // YTD comparison: same period last year (up to today's month+day)
  const now = new Date();
  const ytdCutoff = activeYear === now.getFullYear()
    ? new Date(activeYear - 1, now.getMonth(), now.getDate())  // current year: compare up to today last year
    : new Date(activeYear, 11, 31);  // past year: full year comparison
  const ytdStart = new Date(activeYear - 1, 0, 1);
  const lastYearYTD = revenueInv.filter(i => {
    if (!i.is_valid_from) return false;
    const d = new Date(i.is_valid_from);
    return d >= ytdStart && d <= ytdCutoff;
  }).reduce((s, i) => s + parseFloat(i.total_net || 0), 0);
  const yoy = lastYearYTD > 0 ? ((curYearRev - lastYearYTD) / lastYearYTD * 100) : 0;
  const isYTD = activeYear === now.getFullYear();

  const openInv = invoices.filter(i => i.status === "pending");
  const openTotal = openInv.reduce((s, i) => s + parseFloat(i.total_net || 0), 0);

  // ‚îÄ‚îÄ √ò Rechnungsbetrag ‚îÄ‚îÄ
  const curYearInv = revenueInv.filter(i => i.is_valid_from && new Date(i.is_valid_from).getFullYear() === activeYear);
  const avgInvCurYear = curYearInv.length > 0 ? curYearInv.reduce((s, i) => s + parseFloat(i.total_net || 0), 0) / curYearInv.length : 0;
  const lastYearInv = revenueInv.filter(i => i.is_valid_from && new Date(i.is_valid_from).getFullYear() === activeYear - 1);
  const avgInvLastYear = lastYearInv.length > 0 ? lastYearInv.reduce((s, i) => s + parseFloat(i.total_net || 0), 0) / lastYearInv.length : 0;
  const avgInvChange = avgInvLastYear > 0 ? ((avgInvCurYear - avgInvLastYear) / avgInvLastYear * 100) : 0;
  const avgInvByYear = yearlyData.map(y => ({ year: y.year, avg: y.count > 0 ? y.revenue / y.count : 0, count: y.count }));

  // ‚îÄ‚îÄ Offerten ‚îÄ‚îÄ
  const totalQuotes = quotes.length;
  const acceptedQuotes = quotes.filter(q => q.status === "accepted").length;
  const pendingQuotes = quotes.filter(q => q.status === "pending").length;
  const declinedQuotes = quotes.filter(q => q.status === "declined").length;
  const quoteConv = totalQuotes > 0 ? (acceptedQuotes / totalQuotes * 100) : 0;

  const quotesByYear = {};
  quotes.forEach(q => {
    const dt = q.is_valid_from || q.created_at;
    if (!dt) return;
    const y = new Date(dt).getFullYear();
    if (!quotesByYear[y]) quotesByYear[y] = { total: 0, accepted: 0, declined: 0, pending: 0 };
    quotesByYear[y].total++;
    if (q.status === "accepted") quotesByYear[y].accepted++;
    else if (q.status === "declined") quotesByYear[y].declined++;
    else if (q.status === "pending") quotesByYear[y].pending++;
  });

  // ‚îÄ‚îÄ Top Kunden ‚îÄ‚îÄ
  const custRev = {};
  revenueInv.forEach(inv => {
    if (!inv.contact_id) return;
    if (!custRev[inv.contact_id]) custRev[inv.contact_id] = { id: inv.contact_id, total: 0, count: 0 };
    custRev[inv.contact_id].total += parseFloat(inv.total_net || 0);
    custRev[inv.contact_id].count++;
  });
  const topCust = Object.values(custRev).sort((a, b) => b.total - a.total).slice(0, 8);
  const topMax = topCust[0]?.total || 1;
  const openList = openInv.sort((a, b) => parseFloat(b.total_net || 0) - parseFloat(a.total_net || 0)).slice(0, 8);

  // ‚îÄ‚îÄ Zahlungsmoral (DSO) ‚îÄ‚îÄ
  const paymentMap = {};
  payments.forEach(p => { if (!paymentMap[p.invoice_id]) paymentMap[p.invoice_id] = []; paymentMap[p.invoice_id].push(p); });

  const dsoData = [];
  paidInv.forEach(inv => {
    if (!inv.is_valid_from || !paymentMap[inv.id]) return;
    const invDate = new Date(inv.is_valid_from);
    const pays = paymentMap[inv.id];
    const lastPay = pays.sort((a, b) => new Date(b.payment_date) - new Date(a.payment_date))[0];
    if (!lastPay?.payment_date) return;
    const days = Math.round((new Date(lastPay.payment_date) - invDate) / (1000 * 60 * 60 * 24));
    if (days >= 0 && days < 365) dsoData.push({ year: invDate.getFullYear(), days });
  });

  const dsoByYear = {};
  dsoData.forEach(d => { if (!dsoByYear[d.year]) dsoByYear[d.year] = { sum: 0, count: 0 }; dsoByYear[d.year].sum += d.days; dsoByYear[d.year].count++; });
  const dsoYearlyArr = Object.entries(dsoByYear).map(([y, v]) => ({ year: parseInt(y), avg: v.count > 0 ? v.sum / v.count : 0, count: v.count })).sort((a, b) => a.year - b.year);

  const curDso = dsoData.filter(d => d.year === activeYear);
  const avgDsoCurYear = curDso.length > 0 ? curDso.reduce((s, d) => s + d.days, 0) / curDso.length : 0;
  const lastDso = dsoData.filter(d => d.year === activeYear - 1);
  const avgDsoLastYear = lastDso.length > 0 ? lastDso.reduce((s, d) => s + d.days, 0) / lastDso.length : 0;

  const dsoBuckets = { "0-14": 0, "15-30": 0, "31-60": 0, "61-90": 0, "90+": 0 };
  const relDso = dsoData.filter(d => d.year === activeYear);
  (relDso.length > 10 ? relDso : dsoData).forEach(d => {
    if (d.days <= 14) dsoBuckets["0-14"]++;
    else if (d.days <= 30) dsoBuckets["15-30"]++;
    else if (d.days <= 60) dsoBuckets["31-60"]++;
    else if (d.days <= 90) dsoBuckets["61-90"]++;
    else dsoBuckets["90+"]++;
  });

  // ‚îÄ‚îÄ Kundenentwicklung ‚îÄ‚îÄ
  const custFirstYear = {};
  revenueInv.forEach(inv => {
    if (!inv.contact_id || !inv.is_valid_from) return;
    const y = new Date(inv.is_valid_from).getFullYear();
    if (!custFirstYear[inv.contact_id] || y < custFirstYear[inv.contact_id]) custFirstYear[inv.contact_id] = y;
  });

  const custDevByYear = {};
  revenueInv.forEach(inv => {
    if (!inv.contact_id || !inv.is_valid_from) return;
    const y = new Date(inv.is_valid_from).getFullYear();
    if (!custDevByYear[y]) custDevByYear[y] = { newCust: new Set(), existCust: new Set() };
    if (custFirstYear[inv.contact_id] === y) custDevByYear[y].newCust.add(inv.contact_id);
    else custDevByYear[y].existCust.add(inv.contact_id);
  });
  const custDevArr = Object.entries(custDevByYear).map(([y, v]) => ({
    year: parseInt(y), newCount: v.newCust.size, existCount: v.existCust.size
  })).sort((a, b) => a.year - b.year);

  const curCustDev = custDevArr.find(c => c.year === activeYear);
  const newCustCurYear = curCustDev ? curCustDev.newCount : 0;
  const existCustCurYear = curCustDev ? curCustDev.existCount : 0;

  // ‚îÄ‚îÄ Monthly comparison ‚îÄ‚îÄ
  function monthlyForYear(yr) {
    const m = Array.from({length: 12}, () => ({ revenue: 0, count: 0 }));
    invoices.forEach(inv => {
      if (!inv.is_valid_from || inv.status === "cancelled" || inv.status === "draft") return;
      const d = new Date(inv.is_valid_from);
      if (d.getFullYear() !== yr) return;
      m[d.getMonth()].revenue += parseFloat(inv.total_net || 0);
      m[d.getMonth()].count++;
    });
    return m;
  }
  const monthlyCur = monthlyForYear(activeYear);
  const monthlyPrev = monthlyForYear(activeYear - 1);
  const monthLabels = ["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];

  return {
    yearlyData, years, totalRevenue, curYearRev, yoy, isYTD,
    openTotal, openCount: openInv.length, openList,
    avgInvCurYear, avgInvChange, avgInvByYear, curYearInvCount: curYearInv.length,
    quoteConv, totalQuotes, acceptedQuotes, pendingQuotes, declinedQuotes, quotesByYear,
    topCust, topMax, cm, invoiceCount: revenueInv.length,
    avgDsoCurYear, avgDsoLastYear, dsoYearlyArr, dsoBuckets,
    newCustCurYear, existCustCurYear, custDevArr,
    monthlyCur, monthlyPrev, monthLabels,
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderDashboard(d) {
  const app = document.getElementById("app");

  const yearBtns = d.years.map(y =>
    `<button class="year-btn mono ${y === activeYear ? 'active' : ''}" onclick="switchYear(${y})">${y}</button>`
  ).join("");

  const custRows = d.topCust.map((c, i) => `
    <div class="customer-row">
      <div class="customer-header">
        <span class="customer-name"><span class="customer-rank mono">${String(i+1).padStart(2,'0')}</span>${(d.cm[c.id] || '#'+c.id).substring(0, 30)}</span>
        <span class="customer-amount mono">${formatCHF(c.total)}</span>
      </div>
      <div class="mini-bar"><div class="mini-bar-fill" style="width: ${(c.total/d.topMax*100).toFixed(1)}%"></div></div>
    </div>
  `).join("");

  const invRows = d.openList.length === 0
    ? `<div class="empty-state"><div class="icon">‚úì</div><div>Keine offenen Rechnungen</div></div>`
    : d.openList.map(inv => `
      <div class="inv-row">
        <div>
          <div class="inv-name">${(d.cm[inv.contact_id] || '#'+inv.contact_id).substring(0, 28)}</div>
          <div class="inv-detail mono">${inv.document_nr || '‚Äì'} ¬∑ ${inv.is_valid_from ? new Date(inv.is_valid_from).toLocaleDateString('de-CH') : '‚Äì'}</div>
        </div>
        <span class="inv-amount mono">${formatCHF(inv.total_net)}</span>
      </div>
    `).join("");

  // Funnel
  const maxQ = Math.max(d.totalQuotes, 1);
  const funnelData = [
    { label: "Total", count: d.totalQuotes, pct: 100, color: '#4a90d9' },
    { label: "Angenommen", count: d.acceptedQuotes, pct: (d.acceptedQuotes/maxQ*100), color: '#2a6f4e' },
    { label: "Offen", count: d.pendingQuotes, pct: (d.pendingQuotes/maxQ*100), color: '#e8a54b' },
    { label: "Abgelehnt", count: d.declinedQuotes, pct: (d.declinedQuotes/maxQ*100), color: '#ff6b6b' },
  ];
  const funnelRows = funnelData.map(f => `
    <div class="funnel-row">
      <span class="funnel-label mono">${f.label}</span>
      <div class="funnel-bar-wrap">
        <div class="funnel-bar" style="width: ${Math.max(f.pct, 2)}%; background: ${f.color};">${f.pct > 15 ? formatNum(f.count) : ''}</div>
      </div>
      <span class="funnel-count mono">${formatNum(f.count)}</span>
    </div>
  `).join("");

  const yoyClass = d.yoy > 0 ? "green" : d.yoy < 0 ? "red" : "";
  const yoySign = d.yoy > 0 ? "+" : "";
  const avgChgClass = d.avgInvChange > 0 ? "green" : d.avgInvChange < 0 ? "red" : "";
  const avgChgSign = d.avgInvChange > 0 ? "+" : "";
  const dsoChg = d.avgDsoLastYear > 0 ? d.avgDsoCurYear - d.avgDsoLastYear : 0;
  const dsoClass = dsoChg < 0 ? "green" : dsoChg > 0 ? "red" : "";
  const dsoSign = dsoChg > 0 ? "+" : "";

  app.innerHTML = `
    <div class="header">
      <div>
        <div class="header-sub mono">Drixl Transporte GmbH</div>
        <h1>Finance Dashboard</h1>
      </div>
      <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
        <div class="year-btns">${yearBtns}</div>
        <a href="/vergleich.html" style="font-size: 12px; color: #4ecdc4; text-decoration: none; border: 1px solid #1a3a4a; padding: 6px 14px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; transition: all 0.2s;" onmouseover="this.style.background='#1a3a4a'" onmouseout="this.style.background='transparent'">üìä Periodenvergleich ‚Üí</a>
        <a href="/api/logout" style="font-size: 11px; color: #5a6a7a; text-decoration: none; padding: 6px 10px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; transition: all 0.2s;" onmouseover="this.style.color='#ff6b6b'" onmouseout="this.style.color='#5a6a7a'">‚èª Logout</a>
      </div>
    </div>

    <div class="section-title mono">üìä Umsatz & Kennzahlen</div>
    <div class="kpi-grid">
      <div class="kpi-card accent">
        <div class="kpi-label mono">‚óÜ Umsatz Gesamt</div>
        <div class="kpi-value">${formatCHF(d.totalRevenue)}</div>
        <div class="kpi-sub mono">${formatNum(d.invoiceCount)} Rechnungen (netto)</div>
      </div>
      <div class="kpi-card accent">
        <div class="kpi-label mono">‚ñ≤ Umsatz ${activeYear}</div>
        <div class="kpi-value">${formatCHF(d.curYearRev)}</div>
        <div class="kpi-sub mono ${yoyClass}">${d.yoy !== 0 ? yoySign + d.yoy.toFixed(1) + '% vs ' + (activeYear-1) + (d.isYTD ? ' (YTD)' : '') : '‚Äì'}</div>
      </div>
      <div class="kpi-card warn">
        <div class="kpi-label mono">‚óã Offene Rechnungen</div>
        <div class="kpi-value">${formatCHF(d.openTotal)}</div>
        <div class="kpi-sub mono">${d.openCount} offen</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label mono">‚â° √ò Rechnung ${activeYear}</div>
        <div class="kpi-value">${formatCHF(d.avgInvCurYear)}</div>
        <div class="kpi-sub mono ${avgChgClass}">${d.avgInvChange !== 0 ? avgChgSign + d.avgInvChange.toFixed(1) + '% vs ' + (activeYear-1) : '‚Äì'} ¬∑ ${d.curYearInvCount} Stk</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label mono">‚è± √ò Zahlungsfrist</div>
        <div class="kpi-value">${d.avgDsoCurYear > 0 ? d.avgDsoCurYear.toFixed(0) + ' Tage' : '‚Äì'}</div>
        <div class="kpi-sub mono ${dsoClass}">${dsoChg !== 0 ? dsoSign + dsoChg.toFixed(0) + ' Tage vs ' + (activeYear-1) : '‚Äì'}</div>
      </div>
      <div class="kpi-card info">
        <div class="kpi-label mono">‚óá Offert-Quote</div>
        <div class="kpi-value">${d.quoteConv.toFixed(0)}%</div>
        <div class="kpi-sub mono">${formatNum(d.acceptedQuotes)} / ${formatNum(d.totalQuotes)}</div>
      </div>
    </div>

    <div class="section-title mono">üìà Umsatzentwicklung</div>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title mono">Jahresumsatz (Netto)</div>
        <div class="chart-wrap"><canvas id="yearlyChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title mono">Monatsvergleich ${activeYear} vs ${activeYear - 1}</div>
        <div class="chart-wrap"><canvas id="monthCompareChart"></canvas></div>
      </div>
    </div>

    <div class="section-title mono">üí∞ Rechnungen & Zahlungsmoral</div>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title mono">√ò Rechnungsbetrag pro Jahr</div>
        <div class="chart-wrap"><canvas id="avgInvChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title mono">√ò Tage bis Zahlung pro Jahr</div>
        <div class="chart-wrap"><canvas id="dsoChart"></canvas></div>
      </div>
    </div>

    <div class="section-title mono">üìã Offerten & Kunden</div>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title mono">Zahlungsfrist-Verteilung</div>
        <div class="chart-wrap"><canvas id="dsoBucketChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title mono">Offerten-Pipeline</div>
        <div style="padding-top: 8px;">${funnelRows}</div>
        <div style="margin-top: 12px; font-size: 11px; color: #3a4a5a;" class="mono">Conversion: ${d.quoteConv.toFixed(1)}%</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title mono">Kundenentwicklung (Neu vs. Bestand)</div>
        <div class="chart-wrap"><canvas id="custDevChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title mono">Offert-Quote pro Jahr</div>
        <div class="chart-wrap"><canvas id="quoteYearChart"></canvas></div>
      </div>
    </div>

    <div class="section-title mono">üìë Details</div>
    <div class="bottom-grid">
      <div class="list-card">
        <div class="chart-title mono">Top Kunden (Umsatz Gesamt)</div>
        ${custRows}
      </div>
      <div class="list-card">
        <div class="chart-title mono">Offene Rechnungen</div>
        ${invRows}
      </div>
    </div>

    <div class="footer mono">
      Daten via bexio API ¬∑ Aktualisiert: ${new Date().toLocaleDateString('de-CH')} ${new Date().toLocaleTimeString('de-CH',{hour:'2-digit',minute:'2-digit'})} ¬∑ Powered by Supabase
    </div>
  `;

  drawYearlyChart(d.yearlyData);
  drawMonthCompareChart(d.monthlyCur, d.monthlyPrev, d.monthLabels);
  drawAvgInvChart(d.avgInvByYear);
  drawDsoChart(d.dsoYearlyArr);
  drawDsoBucketChart(d.dsoBuckets);
  drawCustDevChart(d.custDevArr);
  drawQuoteYearChart(d.quotesByYear, d.years);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHART HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const cDef = {
  responsive: true, maintainAspectRatio: false,
  plugins: { legend: { display: false }, tooltip: {
    backgroundColor: '#1a2332', borderColor: '#2a3a4a', borderWidth: 1,
    titleFont: { family: "'JetBrains Mono'" }, bodyFont: { family: "'JetBrains Mono'" },
  }},
};
const ax = {
  x: { grid: { display: false }, ticks: { color: '#4a5a6a', font: { family: "'JetBrains Mono'", size: 11 } } },
  y: { grid: { color: '#1a2332' }, ticks: { color: '#3a4a5a', font: { family: "'JetBrains Mono'", size: 10 } } }
};
function dc(n) { if (charts[n]) { charts[n].destroy(); delete charts[n]; } }
function leg() { return { display: true, position: 'top', labels: { color: '#5a6a7a', font: { family: "'JetBrains Mono'", size: 10 }, boxWidth: 12, padding: 12 } }; }

// ‚îÄ‚îÄ 1) Yearly Revenue ‚îÄ‚îÄ
function drawYearlyChart(data) {
  const ctx = document.getElementById('yearlyChart'); if (!ctx) return; dc('yearly');
  charts.yearly = new Chart(ctx, {
    type: 'bar',
    data: { labels: data.map(d => d.year), datasets: [{ data: data.map(d => d.revenue),
      backgroundColor: data.map(d => d.year === activeYear ? '#4ecdc4' : '#2a6f4e'), borderRadius: 4, borderSkipped: false }] },
    options: { ...cDef, scales: { ...ax, y: { ...ax.y, ticks: { ...ax.y.ticks, callback: v => (v/1000000).toFixed(1)+'M' } } },
      plugins: { ...cDef.plugins, tooltip: { ...cDef.plugins.tooltip, callbacks: { label: c => formatCHF(c.raw) } } } }
  });
}

// ‚îÄ‚îÄ 2) Monthly Compare ‚îÄ‚îÄ
function drawMonthCompareChart(cur, prev, labels) {
  const ctx = document.getElementById('monthCompareChart'); if (!ctx) return; dc('monthCompare');
  charts.monthCompare = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [
      { label: `${activeYear}`, data: cur.map(m => m.revenue), backgroundColor: '#4ecdc4', borderRadius: 3, borderSkipped: false },
      { label: `${activeYear-1}`, data: prev.map(m => m.revenue), backgroundColor: '#1a3a4a', borderRadius: 3, borderSkipped: false },
    ]},
    options: { ...cDef, plugins: { legend: leg(), tooltip: { ...cDef.plugins.tooltip, callbacks: { label: c => `${c.dataset.label}: ${formatCHF(c.raw)}` } } },
      scales: { ...ax, y: { ...ax.y, ticks: { ...ax.y.ticks, callback: v => (v/1000).toFixed(0)+'K' } } } }
  });
}

// ‚îÄ‚îÄ 3) Avg Invoice ‚îÄ‚îÄ
function drawAvgInvChart(data) {
  const ctx = document.getElementById('avgInvChart'); if (!ctx) return; dc('avgInv');
  charts.avgInv = new Chart(ctx, {
    type: 'line',
    data: { labels: data.map(d => d.year), datasets: [{ data: data.map(d => d.avg),
      borderColor: '#6cb4ee', backgroundColor: 'rgba(108,180,238,0.1)', fill: true, tension: 0.3,
      pointBackgroundColor: '#6cb4ee', pointRadius: 4, pointHoverRadius: 7 }] },
    options: { ...cDef, plugins: { ...cDef.plugins, tooltip: { ...cDef.plugins.tooltip,
      callbacks: { label: c => `√ò ${formatCHF(c.raw)} (${data[c.dataIndex].count} Stk)` } } },
      scales: { ...ax, y: { ...ax.y, ticks: { ...ax.y.ticks, callback: v => formatCHF(v) } } } }
  });
}

// ‚îÄ‚îÄ 4) DSO by Year ‚îÄ‚îÄ
function drawDsoChart(data) {
  const ctx = document.getElementById('dsoChart'); if (!ctx) return; dc('dso');
  charts.dso = new Chart(ctx, {
    type: 'bar',
    data: { labels: data.map(d => d.year), datasets: [{ data: data.map(d => d.avg),
      backgroundColor: data.map(d => d.avg <= 30 ? '#2a6f4e' : d.avg <= 45 ? '#e8a54b' : '#ff6b6b'), borderRadius: 4, borderSkipped: false }] },
    options: { ...cDef, plugins: { ...cDef.plugins, tooltip: { ...cDef.plugins.tooltip,
      callbacks: { label: c => `√ò ${c.raw.toFixed(1)} Tage (${data[c.dataIndex].count} Zahlungen)` } } },
      scales: { ...ax, y: { ...ax.y, ticks: { ...ax.y.ticks, callback: v => v + ' T' } } } }
  });
}

// ‚îÄ‚îÄ 5) DSO Distribution ‚îÄ‚îÄ
function drawDsoBucketChart(buckets) {
  const ctx = document.getElementById('dsoBucketChart'); if (!ctx) return; dc('dsoBucket');
  const labels = Object.keys(buckets);
  const values = Object.values(buckets);
  const colors = ['#2a6f4e','#4ecdc4','#e8a54b','#ff8c42','#ff6b6b'];
  charts.dsoBucket = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data: values, backgroundColor: colors, borderColor: '#111820', borderWidth: 3 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: {
      legend: { position: 'right', labels: { color: '#8a9aaa', font: { family: "'JetBrains Mono'", size: 11 }, padding: 12 } },
      tooltip: { ...cDef.plugins.tooltip, callbacks: {
        label: c => { const t = values.reduce((a,b) => a+b, 0); return `${c.label} Tage: ${c.raw} (${(c.raw/t*100).toFixed(0)}%)`; }
      }} } }
  });
}

// ‚îÄ‚îÄ 6) Customer Development ‚îÄ‚îÄ
function drawCustDevChart(data) {
  const ctx = document.getElementById('custDevChart'); if (!ctx) return; dc('custDev');
  charts.custDev = new Chart(ctx, {
    type: 'bar',
    data: { labels: data.map(d => d.year), datasets: [
      { label: 'Neukunden', data: data.map(d => d.newCount), backgroundColor: '#4ecdc4', borderRadius: 3, borderSkipped: false },
      { label: 'Bestandskunden', data: data.map(d => d.existCount), backgroundColor: '#2a6f4e', borderRadius: 3, borderSkipped: false },
    ]},
    options: { ...cDef, plugins: { legend: leg(), tooltip: { ...cDef.plugins.tooltip,
      callbacks: { label: c => `${c.dataset.label}: ${c.raw}` } } },
      scales: { ...ax, x: { ...ax.x, stacked: true }, y: { ...ax.y, stacked: true } } }
  });
}

// ‚îÄ‚îÄ 7) Quote Conversion by Year ‚îÄ‚îÄ
function drawQuoteYearChart(byYear, years) {
  const ctx = document.getElementById('quoteYearChart'); if (!ctx) return; dc('quoteYear');
  const yrs = years.filter(y => byYear[y]).sort();
  charts.quoteYear = new Chart(ctx, {
    type: 'bar',
    data: { labels: yrs, datasets: [
      { label: 'Angenommen', data: yrs.map(y => byYear[y]?.accepted || 0), backgroundColor: '#2a6f4e', borderRadius: 2, borderSkipped: false },
      { label: 'Offen', data: yrs.map(y => byYear[y]?.pending || 0), backgroundColor: '#e8a54b', borderRadius: 2, borderSkipped: false },
      { label: 'Abgelehnt', data: yrs.map(y => byYear[y]?.declined || 0), backgroundColor: '#ff6b6b', borderRadius: 2, borderSkipped: false },
    ]},
    options: { ...cDef, plugins: { legend: leg() }, scales: { ...ax, x: { ...ax.x, stacked: true }, y: { ...ax.y, stacked: true } } }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function init() {
  await loadAllData();
  renderDashboard(processData());
}

function switchYear(y) {
  activeYear = y;
  renderDashboard(processData());
}

init().catch(err => {
  document.getElementById("app").innerHTML = `
    <div class="loading" style="color: #ff6b6b; flex-direction: column; gap: 12px;">
      <div style="font-size: 18px;">Fehler beim Laden</div>
      <div style="font-size: 13px; color: #5a6a7a;">${err.message}</div>
    </div>`;
});
</script>
</body>
</html>
